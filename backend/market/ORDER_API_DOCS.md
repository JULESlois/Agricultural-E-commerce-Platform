# 订单与履约 API 文档

## 概述
本文档描述了农业电商平台的订单与履约相关API接口，包括订单创建、支付、发货、收货确认和发票管理等功能。

## API 列表

### 8.1 (买家)创建订单

**功能**: 买家直接从货源页面下单，或从一个已确认的匹配创建订单。

- **HTTP 方法**: POST
- **Endpoint**: `/api/orders`
- **权限**: 买家用户 (userType = 2)

**请求头**:
```
Authorization: Bearer {buyer_token}
```

**请求体**:
```json
{
  "source_id": 10001,
  "quantity": 2000.00,
  "receiver_address_id": 123,
  "user_coupon_id": 5001,
  "order_remark": "请使用防水包装"
}
```

**响应**:
```json
{
  "code": 201,
  "message": "订单创建成功，请尽快支付。",
  "data": {
    "order_id": "ORD20251110000001",
    "pay_amount": "5600.00"
  }
}
```

**功能特性**:
- 自动计算订单金额（商品价格 + 运费 - 优惠券折扣）
- 支持优惠券使用
- 自动扣减货源库存
- 生成订单明细

---

### 8.2 获取订单列表

**功能**: 买家或卖家查看自己的订单列表。

- **HTTP 方法**: GET
- **Endpoint**: `/api/orders?status=1`
- **权限**: 买家或卖家用户

**请求头**:
```
Authorization: Bearer {user_token}
```

**查询参数**:
- `status`: 订单状态 (0=待付款, 1=待发货, 2=待收货, 3=已取消, 4=已完成)
- `page`: 页码 (默认1)

**响应**:
```json
{
  "code": 200,
  "message": "查询成功。",
  "data": [
    {
      "order_id": "ORD20251110000001",
      "order_status": 1,
      "pay_amount": "5600.00",
      "seller_name": "张三的有机农场",
      "items": [
        {
          "product_name": "2025新产冬小麦（有机认证）",
          "item_quantity": "2000.00"
        }
      ]
    }
  ]
}
```

---

### 8.3 获取订单详情

**功能**: 查看单个订单的完整信息，包括商品、支付、物流、收货人等。

- **HTTP 方法**: GET
- **Endpoint**: `/api/orders/{order_id}`
- **权限**: 订单相关的买家或卖家

**响应**:
```json
{
  "code": 200,
  "message": "查询成功。",
  "data": {
    "order_id": "ORD20251110000001",
    "order_status": 1,
    "pay_amount": "5600.00",
    "items": [...],
    "receiver_info": {
      "receiver": "李四",
      "phone": "13800138000",
      "full_address": "北京市朝阳区xxx街道xxx号"
    }
  }
}
```

---

### 8.4 (买家)支付订单

**功能**: 买家对一个"待付款"的订单发起支付，后端与支付网关交互。

- **HTTP 方法**: POST
- **Endpoint**: `/api/orders/{order_id}/pay`
- **权限**: 订单对应的买家用户

**请求体**:
```json
{
  "payment_method": "WECHAT_PAY"
}
```

**响应**:
```json
{
  "code": 200,
  "message": "支付请求已生成。",
  "data": {
    "payment_gateway_payload": {
      "payment_no": "PAY1699123456789",
      "method": "WECHAT_PAY"
    }
  }
}
```

**功能特性**:
- 验证订单状态（必须是待付款状态）
- 生成支付流水号
- 更新订单状态为已支付

---

### 8.5 (卖家)标记发货

**功能**: 卖家对一个"待发货"的订单进行发货处理，填写物流信息。

- **HTTP 方法**: POST
- **Endpoint**: `/api/farmer/orders/{order_id}/ship`
- **权限**: 订单对应的卖家用户 (userType = 1)

**请求体**:
```json
{
  "delivery_type": 2,
  "logistics_company": "德邦物流",
  "logistics_no": "DB123456789"
}
```

**响应**:
```json
{
  "code": 200,
  "message": "发货成功，订单状态已更新为\"待收货\"。"
}
```

**功能特性**:
- 验证卖家权限和订单状态
- 记录物流信息
- 更新订单状态为待收货

---

### 8.6 (买家)确认收货

**功能**: 买家确认收到货物，订单流程完成。

- **HTTP 方法**: POST
- **Endpoint**: `/api/buyer/orders/{order_id}/confirm-receipt`
- **权限**: 订单对应的买家用户 (userType = 2)

**响应**:
```json
{
  "code": 200,
  "message": "确认收货成功，订单已完成。"
}
```

**功能特性**:
- 验证买家权限和订单状态
- 更新订单状态为已完成
- 记录收货时间

---

### 8.7 (买家)申请发票

**功能**: 买家对一个已完成的订单申请开具发票。

- **HTTP 方法**: POST
- **Endpoint**: `/api/orders/{order_id}/invoice/apply`
- **权限**: 订单对应的买家用户 (userType = 2)

**请求体**:
```json
{
  "invoice_type": 2,
  "invoice_title": "美味果蔬超市",
  "taxpayer_id": "91410100MA12345678",
  "delivery_way": 1
}
```

**响应**:
```json
{
  "code": 200,
  "message": "发票申请已提交，等待处理。"
}
```

**功能特性**:
- 验证订单状态（必须是已完成状态）
- 自动计算发票金额和税额
- 生成发票申请记录

---

### 8.8 (管理员)更新发票状态

**功能**: 管理员处理发票申请，如标记"已开具"并上传电子发票URL。

- **HTTP 方法**: PATCH
- **Endpoint**: `/api/admin/invoices/{invoice_id}`
- **权限**: 管理员用户 (userType = 3)

**请求体**:
```json
{
  "invoice_status": 2,
  "invoice_no": "INV20251110000001",
  "invoice_url": "https://.../invoice/INV20251110000001.pdf"
}
```

**响应**:
```json
{
  "code": 200,
  "message": "发票状态更新成功。"
}
```

## 订单状态说明

| 状态码 | 状态名称 | 说明 |
|--------|----------|------|
| 0 | 待付款 | 订单已创建，等待买家支付 |
| 1 | 待发货 | 订单已支付，等待卖家发货 |
| 2 | 待收货 | 卖家已发货，等待买家确认收货 |
| 3 | 已取消 | 订单已取消 |
| 4 | 已完成 | 买家已确认收货，订单完成 |

## 发票状态说明

| 状态码 | 状态名称 | 说明 |
|--------|----------|------|
| 0 | 待处理 | 发票申请已提交，等待处理 |
| 1 | 处理中 | 发票正在开具中 |
| 2 | 已开具 | 发票已开具完成 |
| 3 | 已发送 | 发票已发送给买家 |
| 4 | 已接收 | 买家已确认收到发票 |
| 5 | 已拒绝 | 发票申请被拒绝 |
| 6 | 已作废 | 发票已作废 |

## 错误处理

所有API都包含统一的错误处理机制：

- **400**: 请求参数错误
- **403**: 权限不足
- **404**: 资源不存在
- **500**: 服务器内部错误

错误响应格式：
```json
{
  "code": 400,
  "message": "错误描述",
  "error": "详细错误信息"
}
```

## 安全特性

1. **权限验证**: 所有接口都需要有效的JWT token
2. **角色检查**: 根据用户类型限制操作权限
3. **订单归属验证**: 确保用户只能操作自己的订单
4. **状态检查**: 验证订单状态是否允许当前操作
5. **数据验证**: 使用Joi进行请求参数验证

## 数据库事务

订单创建过程使用数据库事务确保数据一致性：
- 创建订单主记录
- 创建订单明细记录
- 更新货源库存
- 更新优惠券状态（如果使用）

## 测试

使用 `test-order-api.js` 文件可以测试所有订单相关API功能。需要先设置有效的token。

```bash
node test-order-api.js
```