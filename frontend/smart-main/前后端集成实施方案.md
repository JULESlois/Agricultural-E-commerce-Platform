# æ™ºå†œé“¾å‰åç«¯é›†æˆå®æ–½æ–¹æ¡ˆ

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

å°†å½“å‰çš„é™æ€å‰ç«¯ï¼ˆMock æ•°æ®ï¼‰æ”¹é€ ä¸ºåŠ¨æ€å‰ç«¯ï¼ˆçœŸå® API æ•°æ®ï¼‰ï¼Œå®ç°å®Œæ•´çš„å‰åç«¯äº¤äº’åŠŸèƒ½ã€‚

---

## ğŸ—ï¸ æŠ€æœ¯æ¶æ„

### å½“å‰æŠ€æœ¯æ ˆ
- React 19 + TypeScript
- Vite 6.2
- React Router v7
- è‡ªå®šä¹‰ç»„ä»¶åº“

### éœ€è¦æ–°å¢çš„æŠ€æœ¯
- **HTTP å®¢æˆ·ç«¯**: Axios
- **çŠ¶æ€ç®¡ç†**: Zustandï¼ˆè½»é‡çº§ï¼‰
- **æ•°æ®è¯·æ±‚**: TanStack Query (React Query)
- **è¡¨å•ç®¡ç†**: React Hook Form + Zod
- **ç¯å¢ƒå˜é‡**: .env é…ç½®

---

## ğŸ“¦ ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€è®¾æ–½æ­å»º

### 1.1 å®‰è£…ä¾èµ–

```bash
cd frontend/smart-main

# HTTP å®¢æˆ·ç«¯å’ŒçŠ¶æ€ç®¡ç†
npm install axios zustand

# æ•°æ®è¯·æ±‚å’Œç¼“å­˜
npm install @tanstack/react-query

# è¡¨å•ç®¡ç†
npm install react-hook-form @hookform/resolvers zod

# å·¥å…·åº“
npm install dayjs
```

### 1.2 åˆ›å»ºç›®å½•ç»“æ„

```
frontend/smart-main/src/
â”œâ”€â”€ api/                    # API æ¥å£å®šä¹‰
â”‚   â”œâ”€â”€ client.ts          # Axios å®ä¾‹é…ç½®
â”‚   â”œâ”€â”€ auth.ts            # è®¤è¯ç›¸å…³ API
â”‚   â”œâ”€â”€ market.ts          # å•†åŸç›¸å…³ API
â”‚   â”œâ”€â”€ finance.ts         # é‡‘èç›¸å…³ API
â”‚   â”œâ”€â”€ community.ts       # ç¤¾åŒºç›¸å…³ API
â”‚   â””â”€â”€ knowledge.ts       # çŸ¥è¯†åº“ç›¸å…³ API
â”‚
â”œâ”€â”€ hooks/                  # è‡ªå®šä¹‰ Hooks
â”‚   â”œâ”€â”€ useAuth.ts         # è®¤è¯ Hook
â”‚   â”œâ”€â”€ useProducts.ts     # å•†å“æ•°æ® Hook
â”‚   â””â”€â”€ useUser.ts         # ç”¨æˆ·ä¿¡æ¯ Hook
â”‚
â”œâ”€â”€ store/                  # Zustand çŠ¶æ€ç®¡ç†
â”‚   â”œâ”€â”€ useAuthStore.ts    # è®¤è¯çŠ¶æ€
â”‚   â”œâ”€â”€ useCartStore.ts    # è´­ç‰©è½¦çŠ¶æ€
â”‚   â””â”€â”€ useAppStore.ts     # å…¨å±€ UI çŠ¶æ€
â”‚
â””â”€â”€ utils/                  # å·¥å…·å‡½æ•°
    â”œâ”€â”€ request.ts         # è¯·æ±‚å°è£…
    â”œâ”€â”€ storage.ts         # æœ¬åœ°å­˜å‚¨
    â””â”€â”€ format.ts          # æ ¼å¼åŒ–å·¥å…·
```

---

## ğŸ”§ ç¬¬äºŒé˜¶æ®µï¼šæ ¸å¿ƒæ¨¡å—å®ç°

### 2.1 Axios å®¢æˆ·ç«¯é…ç½®

**æ–‡ä»¶**: `src/api/client.ts`

```typescript
import axios, { AxiosInstance, AxiosRequestConfig, AxiosResponse } from 'axios';

// API åŸºç¡€ URL
const BASE_URL = import.meta.env.VITE_API_BASE_URL || 'http://localhost:3000/api';

// åˆ›å»º Axios å®ä¾‹
const client: AxiosInstance = axios.create({
  baseURL: BASE_URL,
  timeout: 10000,
  headers: {
    'Content-Type': 'application/json',
  },
});

// è¯·æ±‚æ‹¦æˆªå™¨
client.interceptors.request.use(
  (config) => {
    // ä» localStorage è·å– token
    const token = localStorage.getItem('token');
    if (token) {
      config.headers.Authorization = `Bearer ${token}`;
    }
    return config;
  },
  (error) => {
    return Promise.reject(error);
  }
);

// å“åº”æ‹¦æˆªå™¨
client.interceptors.response.use(
  (response: AxiosResponse) => {
    return response.data;
  },
  (error) => {
    // ç»Ÿä¸€é”™è¯¯å¤„ç†
    if (error.response?.status === 401) {
      // æœªæˆæƒï¼Œè·³è½¬ç™»å½•
      localStorage.removeItem('token');
      window.location.href = '/auth/login';
    }
    return Promise.reject(error);
  }
);

export default client;
```

### 2.2 è®¤è¯çŠ¶æ€ç®¡ç†

**æ–‡ä»¶**: `src/store/useAuthStore.ts`

```typescript
import { create } from 'zustand';
import { persist } from 'zustand/middleware';

interface User {
  id: string;
  name: string;
  email: string;
  role: 'FARMER' | 'BUYER' | 'BANKER' | 'EXPERT' | 'ADMIN';
  avatar?: string;
}

interface AuthState {
  token: string | null;
  user: User | null;
  isAuthenticated: boolean;
  login: (token: string, user: User) => void;
  logout: () => void;
  updateUser: (user: Partial<User>) => void;
}

export const useAuthStore = create<AuthState>()(
  persist(
    (set) => ({
      token: null,
      user: null,
      isAuthenticated: false,
      
      login: (token, user) => {
        localStorage.setItem('token', token);
        set({ token, user, isAuthenticated: true });
      },
      
      logout: () => {
        localStorage.removeItem('token');
        set({ token: null, user: null, isAuthenticated: false });
      },
      
      updateUser: (userData) => {
        set((state) => ({
          user: state.user ? { ...state.user, ...userData } : null,
        }));
      },
    }),
    {
      name: 'auth-storage',
    }
  )
);
```

### 2.3 å•†åŸ API æ¥å£

**æ–‡ä»¶**: `src/api/market.ts`

```typescript
import client from './client';
import { Product, Category } from '../types';

// è·å–å•†å“åˆ—è¡¨
export const getProducts = async (params?: {
  category?: string;
  keyword?: string;
  page?: number;
  pageSize?: number;
  sortBy?: 'price' | 'sales' | 'newest';
  sortOrder?: 'asc' | 'desc';
}) => {
  return client.get<any, { data: Product[]; total: number }>('/market/products', { params });
};

// è·å–å•†å“è¯¦æƒ…
export const getProductDetail = async (id: string) => {
  return client.get<any, Product>(`/market/products/${id}`);
};

// è·å–åˆ†ç±»åˆ—è¡¨
export const getCategories = async () => {
  return client.get<any, Category[]>('/market/categories');
};

// æœç´¢å•†å“
export const searchProducts = async (keyword: string) => {
  return client.get<any, Product[]>('/market/products/search', {
    params: { keyword },
  });
};

// æ·»åŠ åˆ°è´­ç‰©è½¦
export const addToCart = async (productId: string, quantity: number) => {
  return client.post('/market/cart/add', { productId, quantity });
};

// è·å–è´­ç‰©è½¦
export const getCart = async () => {
  return client.get('/market/cart');
};
```

### 2.4 React Query Hook ç¤ºä¾‹

**æ–‡ä»¶**: `src/hooks/useProducts.ts`

```typescript
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { getProducts, getProductDetail, addToCart } from '../api/market';

// è·å–å•†å“åˆ—è¡¨
export const useProducts = (params?: any) => {
  return useQuery({
    queryKey: ['products', params],
    queryFn: () => getProducts(params),
    staleTime: 5 * 60 * 1000, // 5åˆ†é’Ÿå†…æ•°æ®ä¸è¿‡æœŸ
  });
};

// è·å–å•†å“è¯¦æƒ…
export const useProductDetail = (id: string) => {
  return useQuery({
    queryKey: ['product', id],
    queryFn: () => getProductDetail(id),
    enabled: !!id, // åªæœ‰ id å­˜åœ¨æ—¶æ‰è¯·æ±‚
  });
};

// æ·»åŠ åˆ°è´­ç‰©è½¦
export const useAddToCart = () => {
  const queryClient = useQueryClient();
  
  return useMutation({
    mutationFn: ({ productId, quantity }: { productId: string; quantity: number }) =>
      addToCart(productId, quantity),
    onSuccess: () => {
      // åˆ·æ–°è´­ç‰©è½¦æ•°æ®
      queryClient.invalidateQueries({ queryKey: ['cart'] });
    },
  });
};
```

---

## ğŸ¯ ç¬¬ä¸‰é˜¶æ®µï¼šé¡µé¢æ”¹é€ ç¤ºä¾‹

### 3.1 å•†åŸé¦–é¡µæ”¹é€ 

**ä¿®æ”¹å‰** (ä½¿ç”¨ Mock æ•°æ®):
```typescript
import { MOCK_PRODUCTS } from '../constants';

export const MallHome = () => {
  const products = MOCK_PRODUCTS;
  // ...
};
```

**ä¿®æ”¹å** (ä½¿ç”¨çœŸå® API):
```typescript
import { useProducts } from '../hooks/useProducts';
import { Spin, Alert } from 'antd';

export const MallHome = () => {
  const [filters, setFilters] = useState({
    category: '',
    sortBy: 'comprehensive',
    page: 1,
  });
  
  const { data, isLoading, error } = useProducts(filters);
  
  if (isLoading) {
    return <Spin size="large" className="flex justify-center py-20" />;
  }
  
  if (error) {
    return <Alert type="error" message="åŠ è½½å¤±è´¥" description={error.message} />;
  }
  
  const products = data?.data || [];
  
  return (
    <div>
      {/* ç­›é€‰å™¨ */}
      <FilterBar filters={filters} onChange={setFilters} />
      
      {/* å•†å“åˆ—è¡¨ */}
      <ProductGrid products={products} />
      
      {/* åˆ†é¡µ */}
      <Pagination 
        current={filters.page} 
        total={data?.total} 
        onChange={(page) => setFilters({ ...filters, page })}
      />
    </div>
  );
};
```

### 3.2 å•†å“è¯¦æƒ…é¡µæ”¹é€ 

```typescript
import { useParams } from 'react-router-dom';
import { useProductDetail } from '../hooks/useProducts';
import { useAddToCart } from '../hooks/useProducts';

export const ProductDetail = () => {
  const { id } = useParams<{ id: string }>();
  const { data: product, isLoading } = useProductDetail(id!);
  const addToCart = useAddToCart();
  
  const handleAddToCart = () => {
    addToCart.mutate(
      { productId: id!, quantity: 1 },
      {
        onSuccess: () => {
          message.success('å·²æ·»åŠ åˆ°è´­ç‰©è½¦');
        },
      }
    );
  };
  
  if (isLoading) return <PageLoading />;
  if (!product) return <NotFound />;
  
  return (
    <div>
      <img src={product.imageUrl} alt={product.title} />
      <h1>{product.title}</h1>
      <p className="price">Â¥{product.price}</p>
      <button onClick={handleAddToCart} disabled={addToCart.isPending}>
        {addToCart.isPending ? 'æ·»åŠ ä¸­...' : 'åŠ å…¥è´­ç‰©è½¦'}
      </button>
    </div>
  );
};
```

---

## ğŸ—ºï¸ ç¬¬å››é˜¶æ®µï¼šæ¨¡å—å¯¹æ¥è®¡åˆ’

### 4.1 å•†åŸæ¨¡å— (Market)

**åç«¯ API**: `backend/market/`

| åŠŸèƒ½ | å‰ç«¯é¡µé¢ | åç«¯æ¥å£ | ä¼˜å…ˆçº§ |
|------|---------|---------|--------|
| å•†å“åˆ—è¡¨ | Mall.tsx | GET /api/market/products | P0 |
| å•†å“è¯¦æƒ… | ProductDetail.tsx | GET /api/market/products/:id | P0 |
| åˆ†ç±»ç®¡ç† | Mall.tsx | GET /api/market/categories | P1 |
| è´­ç‰©è½¦ | Cart.tsx | GET/POST /api/market/cart | P0 |
| è®¢å•åˆ›å»º | Checkout.tsx | POST /api/market/orders | P0 |
| è®¢å•åˆ—è¡¨ | BuyerOrders.tsx | GET /api/market/orders | P1 |

### 4.2 é‡‘èæ¨¡å— (Finance)

**åç«¯ API**: `backend/finance/`

| åŠŸèƒ½ | å‰ç«¯é¡µé¢ | åç«¯æ¥å£ | ä¼˜å…ˆçº§ |
|------|---------|---------|--------|
| è´·æ¬¾äº§å“åˆ—è¡¨ | Finance.tsx | GET /api/finance/loan-types | P0 |
| ç”³è¯·è´·æ¬¾ | LoanApplyWizard.tsx | POST /api/finance/applications | P0 |
| ç”³è¯·åˆ—è¡¨ | FarmerFinance.tsx | GET /api/finance/applications | P1 |
| å®¡æ‰¹åˆ—è¡¨ | FinanceBanker.tsx | GET /api/finance/approvals | P1 |
| å®¡æ‰¹æ“ä½œ | BankerApprovalDetail.tsx | PUT /api/finance/approvals/:id | P1 |

### 4.3 ç¤¾åŒºæ¨¡å— (Community)

**åç«¯ API**: `backend/community/`

| åŠŸèƒ½ | å‰ç«¯é¡µé¢ | åç«¯æ¥å£ | ä¼˜å…ˆçº§ |
|------|---------|---------|--------|
| å¸–å­åˆ—è¡¨ | Community.tsx | GET /api/community/posts | P0 |
| å‘å¸ƒå¸–å­ | Community.tsx | POST /api/community/posts | P1 |
| ç‚¹èµ/è¯„è®º | Community.tsx | POST /api/community/posts/:id/like | P2 |
| çƒ­é—¨è¯é¢˜ | Community.tsx | GET /api/community/topics/hot | P2 |

### 4.4 çŸ¥è¯†åº“æ¨¡å— (Knowledge)

**åç«¯ API**: `backend/help/` (å¯èƒ½éœ€è¦é‡å‘½å)

| åŠŸèƒ½ | å‰ç«¯é¡µé¢ | åç«¯æ¥å£ | ä¼˜å…ˆçº§ |
|------|---------|---------|--------|
| ä¸“å®¶åˆ—è¡¨ | Knowledge.tsx | GET /api/knowledge/experts | P1 |
| æ–‡ç« åˆ—è¡¨ | Knowledge.tsx | GET /api/knowledge/articles | P1 |
| æ–‡ç« è¯¦æƒ… | ArticleDetail.tsx | GET /api/knowledge/articles/:id | P1 |
| æé—® | AskQuestion.tsx | POST /api/knowledge/questions | P2 |

---

## ğŸ” ç¬¬äº”é˜¶æ®µï¼šè®¤è¯ä¸æƒé™

### 5.1 ç™»å½•æµç¨‹

```typescript
// src/pages/Auth.tsx
import { useAuthStore } from '../store/useAuthStore';
import { login as loginApi } from '../api/auth';

export const Login = () => {
  const { login } = useAuthStore();
  const navigate = useNavigate();
  
  const handleLogin = async (values: { email: string; password: string }) => {
    try {
      const { token, user } = await loginApi(values);
      login(token, user);
      
      // æ ¹æ®è§’è‰²è·³è½¬
      switch (user.role) {
        case 'FARMER':
          navigate('/mall/seller/dashboard');
          break;
        case 'BUYER':
          navigate('/mall/buyer/orders');
          break;
        case 'BANKER':
          navigate('/finance/banker/dashboard');
          break;
        default:
          navigate('/');
      }
    } catch (error) {
      message.error('ç™»å½•å¤±è´¥');
    }
  };
  
  return <LoginForm onSubmit={handleLogin} />;
};
```

### 5.2 è·¯ç”±å®ˆå«

```typescript
// src/components/ProtectedRoute.tsx
import { useAuthStore } from '../store/useAuthStore';
import { Navigate } from 'react-router-dom';

export const ProtectedRoute = ({ 
  children, 
  requiredRole 
}: { 
  children: React.ReactNode; 
  requiredRole?: string;
}) => {
  const { isAuthenticated, user } = useAuthStore();
  
  if (!isAuthenticated) {
    return <Navigate to="/auth/login" replace />;
  }
  
  if (requiredRole && user?.role !== requiredRole) {
    return <Navigate to="/" replace />;
  }
  
  return <>{children}</>;
};
```

---

## ğŸ“ ç¬¬å…­é˜¶æ®µï¼šç¯å¢ƒé…ç½®

### 6.1 ç¯å¢ƒå˜é‡

**æ–‡ä»¶**: `.env.development`
```env
VITE_API_BASE_URL=http://localhost:3000/api
VITE_APP_NAME=æ™ºå†œé“¾
```

**æ–‡ä»¶**: `.env.production`
```env
VITE_API_BASE_URL=https://api.smartagro.com/api
VITE_APP_NAME=æ™ºå†œé“¾
```

### 6.2 Vite é…ç½®æ›´æ–°

```typescript
// vite.config.ts
export default defineConfig({
  server: {
    proxy: {
      '/api': {
        target: 'http://localhost:3000',
        changeOrigin: true,
      },
    },
  },
});
```

---

## ğŸš€ å®æ–½æ—¶é—´è¡¨

### Sprint 1 (Week 1-2): åŸºç¡€è®¾æ–½
- [ ] å®‰è£…ä¾èµ–
- [ ] åˆ›å»ºç›®å½•ç»“æ„
- [ ] é…ç½® Axios å®¢æˆ·ç«¯
- [ ] å®ç°è®¤è¯çŠ¶æ€ç®¡ç†
- [ ] é…ç½® React Query

### Sprint 2 (Week 3-4): å•†åŸæ¨¡å—
- [ ] å•†å“åˆ—è¡¨ API å¯¹æ¥
- [ ] å•†å“è¯¦æƒ… API å¯¹æ¥
- [ ] è´­ç‰©è½¦åŠŸèƒ½
- [ ] è®¢å•åˆ›å»ºæµç¨‹

### Sprint 3 (Week 5-6): é‡‘èæ¨¡å—
- [ ] è´·æ¬¾äº§å“å±•ç¤º
- [ ] è´·æ¬¾ç”³è¯·è¡¨å•
- [ ] å†œæˆ·ç«¯è´·æ¬¾ç®¡ç†
- [ ] é“¶è¡Œç«¯å®¡æ‰¹åŠŸèƒ½

### Sprint 4 (Week 7-8): ç¤¾åŒºä¸çŸ¥è¯†åº“
- [ ] ç¤¾åŒºå¸–å­åˆ—è¡¨
- [ ] å‘å¸–åŠŸèƒ½
- [ ] ä¸“å®¶åˆ—è¡¨
- [ ] æ–‡ç« å±•ç¤º

### Sprint 5 (Week 9-10): ä¼˜åŒ–ä¸æµ‹è¯•
- [ ] æ€§èƒ½ä¼˜åŒ–
- [ ] é”™è¯¯å¤„ç†å®Œå–„
- [ ] ç”¨æˆ·ä½“éªŒä¼˜åŒ–
- [ ] é›†æˆæµ‹è¯•

---

## ğŸ“š å‚è€ƒæ–‡æ¡£

- [åç«¯ API æ–‡æ¡£](../backend/)
- [å‰ç«¯ç»“æ„æ–‡æ¡£](./å‰ç«¯ç»“æ„.md)
- [React Query æ–‡æ¡£](https://tanstack.com/query/latest)
- [Zustand æ–‡æ¡£](https://zustand-demo.pmnd.rs/)

---

**åˆ›å»ºæ—¶é—´**: 2025-11-28  
**ç»´æŠ¤è€…**: æ™ºå†œé“¾å¼€å‘å›¢é˜Ÿ
